name: Translate Qt TS (AOAI) -> Release (with PTL)

on:
  workflow_dispatch:
    inputs:
      input_ts:
        description: "Input .ts file path"
        required: true
        default: "packet_tracer_template/template.ts"
      output_ts:
        description: "Output .ts file path"
        required: true
        default: "template.ja_JP.ts"
      ptl_out:
        description: "Output .ptl file path"
        required: true
        default: "template.ja_JP.ptl"

      language:
        description: "TS language attribute"
        required: true
        default: "ja_JP"
      target_name:
        description: "Target language display name"
        required: true
        default: "Japanese"

      concurrency:
        description: "Concurrent requests"
        required: true
        default: "10"
      progress_every:
        description: "Progress every N"
        required: true
        default: "50"
      max_retries:
        description: "Max retries"
        required: true
        default: "6"
      timeout_sec:
        description: "Timeout seconds"
        required: true
        default: "60"
      save_every:
        description: "Save partial every N"
        required: true
        default: "200"

      release_tag:
        description: "Release tag"
        required: true
        default: "ts-translation"
      release_name:
        description: "Release name"
        required: true
        default: "Qt TS Translation"
      prerelease:
        description: "Pre-release? (true/false)"
        required: true
        default: "false"
      release_notes:
        description: "Release notes"
        required: true
        default: "Automated translation output."

permissions:
  contents: write

jobs:
  translate:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install openai python-dotenv

      - name: Install Qt lrelease
        run: |
          sudo apt-get update
          sudo apt-get install -y qt6-l10n-tools
          command -v lrelease
          dpkg -s qt6-l10n-tools | sed -n 's/^Version: //p'


      - name: Run translation + PTL export
        env:
          AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
          AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
          AZURE_OPENAI_DEPLOYMENT: ${{ secrets.AZURE_OPENAI_DEPLOYMENT }}
        run: |
          set -e
          python src/main.py "${{ inputs.input_ts }}" \
            -o "${{ inputs.output_ts }}" \
            --language "${{ inputs.language }}" \
            --target-name "${{ inputs.target_name }}" \
            --concurrency "${{ inputs.concurrency }}" \
            --progress-every "${{ inputs.progress_every }}" \
            --max-retries "${{ inputs.max_retries }}" \
            --timeout-sec "${{ inputs.timeout_sec }}" \
            --save-every "${{ inputs.save_every }}" \
            --ptl-out "${{ inputs.ptl_out }}"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: translate-output
          path: |
            ${{ inputs.output_ts }}
            ${{ inputs.output_ts }}.partial
            ${{ inputs.ptl_out }}
            translate_failed.jsonl
          if-no-files-found: warn

      - name: Create/Update Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.release_tag }}
          name: ${{ inputs.release_name }}
          prerelease: ${{ inputs.prerelease }}
          body: ${{ inputs.release_notes }}
          files: |
            ${{ inputs.output_ts }}
            ${{ inputs.ptl_out }}
            translate_failed.jsonl
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

