name: Translate Qt TS (AOAI) -> Release

on:
  workflow_dispatch:
    inputs:
      input_ts:
        description: "Input .ts file path (relative to repo)"
        required: true
        default: "CiscoPacketTracerTemplate/template.ts"
      output_ts:
        description: "Output .ts file path (relative to repo)"
        required: true
        default: "template.ja_JP.ts"
      language:
        description: "TS language attribute (e.g., ja_JP)"
        required: true
        default: "ja_JP"
      target_name:
        description: "Target language display name (e.g., Japanese)"
        required: true
        default: "Japanese"

      concurrency:
        description: "Concurrent requests"
        required: true
        default: "10"
      progress_every:
        description: "Print progress every N processed items"
        required: true
        default: "50"
      max_retries:
        description: "Max retries for transient failures"
        required: true
        default: "6"
      timeout_sec:
        description: "Per-request timeout seconds"
        required: true
        default: "60"
      save_every:
        description: "Write partial output every N processed items"
        required: true
        default: "200"
      reset_failed_log:
        description: "Reset failed log before run (true/false)"
        required: true
        default: "true"

      release_tag:
        description: "Release tag (e.g., ts-2026-01-11)"
        required: true
        default: "ts-translation"
      release_name:
        description: "Release name"
        required: true
        default: "Qt TS Translation"
      prerelease:
        description: "Pre-release? (true/false)"
        required: true
        default: "false"
      release_notes:
        description: "Release notes (markdown ok)"
        required: true
        default: |
          Automated translation output.

      # optional price overrides (manual)
      price_input_per_1m:
        description: "Price: input USD per 1M tokens (optional)"
        required: false
        default: ""
      price_output_per_1m:
        description: "Price: output USD per 1M tokens (optional)"
        required: false
        default: ""

permissions:
  contents: write

jobs:
  translate:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install openai python-dotenv

      - name: Validate input file
        run: |
          set -e
          test -f "${{ inputs.input_ts }}" || (echo "Input file not found: ${{ inputs.input_ts }}" && exit 1)

      - name: Run translation
        env:
          # AOAI secrets
          AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
          AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
          AZURE_OPENAI_DEPLOYMENT: ${{ secrets.AZURE_OPENAI_DEPLOYMENT }}

          # Pricing: input override > repo var > script default
          PRICE_INPUT_PER_1M: ${{ inputs.price_input_per_1m != '' && inputs.price_input_per_1m || vars.PRICE_INPUT_PER_1M }}
          PRICE_OUTPUT_PER_1M: ${{ inputs.price_output_per_1m != '' && inputs.price_output_per_1m || vars.PRICE_OUTPUT_PER_1M }}
        run: |
          set -e

          RESET_FLAG=""
          if [ "${{ inputs.reset_failed_log }}" = "true" ]; then
            RESET_FLAG="--reset-failed-log"
          fi

          python src/main.py "${{ inputs.input_ts }}" \
            -o "${{ inputs.output_ts }}" \
            --language "${{ inputs.language }}" \
            --target-name "${{ inputs.target_name }}" \
            --concurrency "${{ inputs.concurrency }}" \
            --progress-every "${{ inputs.progress_every }}" \
            --max-retries "${{ inputs.max_retries }}" \
            --timeout-sec "${{ inputs.timeout_sec }}" \
            --save-every "${{ inputs.save_every }}" \
            $RESET_FLAG

      - name: Upload artifacts (output + partial + failed log)
        uses: actions/upload-artifact@v4
        with:
          name: translate-ts-artifacts
          path: |
            ${{ inputs.output_ts }}
            ${{ inputs.output_ts }}.partial
            translate_failed.jsonl
          if-no-files-found: warn

      - name: Create or Update Release (attach files)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.release_tag }}
          name: ${{ inputs.release_name }}
          prerelease: ${{ inputs.prerelease }}
          body: ${{ inputs.release_notes }}
          files: |
            ${{ inputs.output_ts }}
            translate_failed.jsonl
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
